# Documentation SystÃ¨me d'Authentification - HerbisVeritas V2

## Vue d'Ensemble

Le systÃ¨me d'authentification HerbisVeritas V2 utilise **Supabase Auth** avec Next.js 15 App Router, intÃ©grant une architecture complÃ¨te de gestion des rÃ´les, middleware de protection des routes et hooks personnalisÃ©s.

**Architecture :** TDD First, Security-First, Production-Ready  
**Stack :** Supabase Auth + Next.js 15 + Zod Validation + TypeScript  
**SÃ©curitÃ© :** RLS Policies + Rate Limiting + RBAC + SSR-Safe

---

## Architecture Globale

### Structure des Fichiers

```
src/lib/auth/
â”œâ”€â”€ actions.ts              # Actions serveur auth (loginUser, registerUser)
â”œâ”€â”€ auth-service.ts         # Service authentification (legacy)
â”œâ”€â”€ middleware.ts           # Helpers middleware auth
â”œâ”€â”€ roles.ts                # Configuration rÃ´les et redirections
â””â”€â”€ hooks/
    â””â”€â”€ use-auth-actions.ts # Hook client pour actions auth

src/lib/supabase/
â”œâ”€â”€ client.ts               # Client Supabase navigateur
â”œâ”€â”€ server.ts               # Client Supabase serveur
â”œâ”€â”€ middleware.ts           # Client Supabase middleware
â””â”€â”€ hooks/
    â””â”€â”€ use-supabase.ts     # Hook unifiÃ© Supabase

src/components/forms/
â”œâ”€â”€ login-form/
â”‚   â”œâ”€â”€ form-validation.ts  # Validation Zod login (6 char min)
â”‚   â””â”€â”€ index.tsx          # Composant formulaire login
â””â”€â”€ signup-form/
    â”œâ”€â”€ form-validation.ts  # Validation Zod register (8 char min)
    â””â”€â”€ index.tsx          # Composant formulaire register

app/(auth)/
â”œâ”€â”€ login/page.tsx          # Page connexion
â””â”€â”€ signup/page.tsx         # Page inscription
```

### Flow d'Authentification

```mermaid
graph TD
    A[User Login] --> B[loginUser action]
    B --> C[Validation Zod]
    C --> D[Supabase Auth signInWithPassword]
    D --> E[Session Cookie SSR]
    E --> F[Middleware Check]
    F --> G{Route Protected?}
    G -->|Yes| H[Role Validation]
    G -->|No| I[Allow Access]
    H --> J{Role Sufficient?}
    J -->|Yes| K[Role Redirect]
    J -->|No| L[403 Forbidden]
    K --> M[/profile, /admin, /dev]
```

---

## Actions d'Authentification

### API Actions Serveur

#### Connexion Utilisateur

```typescript
import { loginUser } from '@/lib/auth/actions'

const result = await loginUser({
  email: 'user@herbisveritas.fr',
  password: 'SecurePass123!'
})

// RÃ©sultat
interface LoginResult {
  success: boolean
  user?: AuthUser
  error?: string
  redirectTo?: string
}

// Exemple de redirection selon rÃ´le
if (result.success) {
  // user -> /profile
  // admin -> /admin  
  // dev -> /dev
}
```

#### CrÃ©ation de Compte

```typescript
import { registerUser } from '@/lib/auth/actions'

const result = await registerUser({
  email: 'newuser@herbisveritas.fr',
  password: 'SecurePass123!',
  confirmPassword: 'SecurePass123!',
  acceptTerms: true
})

// RÃ©sultat
interface RegisterResult {
  success: boolean
  user?: AuthUser
  message?: string
  error?: string
  requiresConfirmation?: boolean
}
```

### Hooks Client

#### useAuthActions

```typescript
import { useAuthActions } from '@/lib/auth/hooks/use-auth-actions'

function LoginComponent() {
  const { signIn, signUp, loading, error } = useAuthActions()
  
  const handleLogin = async () => {
    const result = await signIn(email, password, '/dashboard')
    if (result.success) {
      // Redirection automatique
    }
  }
}
```

#### useSupabase

```typescript
import { useSupabase } from '@/lib/supabase/hooks/use-supabase'

function ProfileComponent() {
  const { user, signOut, loading } = useSupabase()
  
  if (loading) return <div>Loading...</div>
  if (!user) return <div>Please login</div>
  
  return (
    <div>
      <p>Welcome {user.user_metadata?.firstName}</p>
      <button onClick={() => signOut()}>Logout</button>
    </div>
  )
}
```

---

## SystÃ¨me de RÃ´les

### Configuration des RÃ´les

```typescript
// src/lib/auth/roles.ts
export const USER_ROLES = {
  GUEST: 'guest',
  USER: 'user', 
  DEV: 'dev',
  ADMIN: 'admin'
} as const

// Redirections aprÃ¨s connexion
export const ROLE_REDIRECTS = {
  guest: '/',
  user: '/profile',
  dev: '/dev',          // Interface dÃ©veloppeur
  admin: '/admin'       // Interface administrateur
}
```

### Matrice des Permissions

| RÃ´le | Description | AccÃ¨s |
|------|-------------|-------|
| **guest** | Visiteur non connectÃ© | Pages publiques uniquement |
| **user** | Utilisateur standard | Profile, commandes, wishlist |
| **admin** | Administrateur | Gestion produits, commandes, utilisateurs |
| **dev** | DÃ©veloppeur | Interface debug + accÃ¨s admin |

### Protection des Routes

**Routes publiques :**
```typescript
// AccÃ¨s libre (tous rÃ´les)
const PUBLIC_ROUTES = [
  '/', '/shop', '/products', '/about', '/contact'
]
```

**Routes authentifiÃ©es :**
```typescript
// Connexion requise (user minimum)
const PROTECTED_ROUTES = [
  '/profile', '/orders', '/addresses', '/wishlist'
]
```

**Routes admin :**
```typescript
// Admin ou dev requis
const ADMIN_ROUTES = [
  '/admin/*'
]
```

**Routes dÃ©veloppeur :**
```typescript
// Dev uniquement
const DEV_ROUTES = [
  '/dev/*'
]
```

---

## Middleware de Protection

### Configuration Next.js 15

```typescript
// src/middleware.ts
import { createMiddlewareClient } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
  const { supabase, response } = await createMiddlewareClient(request)
  
  // RÃ©cupÃ©ration session
  const { data: { session } } = await supabase.auth.getSession()
  const user = session?.user
  
  // Validation route + rÃ´le
  const pathname = request.nextUrl.pathname
  const userRole = getUserRole(user)
  
  // Protection et redirection
  return handleRouteProtection(request, response, userRole, pathname)
}

// Matcher pour Ã©viter API routes
export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

### Gestion des Erreurs

**Comportements automatiques :**
- **Non connectÃ© â†’ Route protÃ©gÃ©e :** Redirection `/login?redirectedFrom=/target`
- **RÃ´le insuffisant :** Redirection `/unauthorized` + log sÃ©curitÃ©
- **Token expirÃ© :** Nettoyage cookies + redirection login
- **Erreur Supabase :** 503 Service Unavailable

---

## Validation des Formulaires

### Validation Login (Client)

```typescript
// src/components/forms/login-form/form-validation.ts
import { z } from 'zod'

export const loginFormSchema = z.object({
  email: z
    .string()
    .min(1, 'Email requis')
    .email('Format email invalide'),
  password: z
    .string()
    .min(6, 'Mot de passe trop court (min. 6 caractÃ¨res)')
})

export const validateLoginForm = (formData: LoginFormData): FormErrors => {
  // Validation temps rÃ©el cÃ´tÃ© client
}
```

### Validation Register (Client + Serveur)

```typescript
// src/components/forms/signup-form/form-validation.ts
export const signupFormSchema = z.object({
  email: z.string().email('Format email invalide'),
  password: z
    .string()
    .min(8, 'Mot de passe trop court (min. 8 caractÃ¨res)')
    .regex(/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, 
      'Le mot de passe doit contenir au moins une minuscule, une majuscule et un chiffre'
    ),
  confirmPassword: z.string(),
  firstName: z.string().min(2, 'PrÃ©nom trop court'),
  lastName: z.string().min(2, 'Nom trop court')
}).refine((data) => data.password === data.confirmPassword, {
  message: 'Les mots de passe ne correspondent pas',
  path: ['confirmPassword']
})
```

---

## Architecture Supabase

### Configuration Client

```typescript
// src/lib/supabase/client.ts
export const createClient = () => 
  createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
```

### Configuration Serveur

```typescript
// src/lib/supabase/server.ts  
export const createClient = () =>
  createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll(cookiesToSet) { 
          cookiesToSet.forEach(({ name, value, options }) => 
            cookieStore.set(name, value, options))
        },
      },
    }
  )
```

### Configuration Middleware

```typescript
// src/lib/supabase/middleware.ts
export const createMiddlewareClient = async (request: NextRequest) => {
  let response = NextResponse.next({ request })

  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return request.cookies.getAll() },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value)
            response.cookies.set(name, value, options)
          })
        },
      },
    }
  )

  return { supabase, response }
}
```

---

## Tests TDD

### Architecture de Test

**Approche Test-Driven Development :**
- ðŸ”´ **Red :** Tests Ã©crits AVANT implÃ©mentation
- ðŸŸ¢ **Green :** Code minimal pour faire passer les tests
- ðŸ”µ **Refactor :** AmÃ©lioration sans casser les tests

### Configuration Tests

```javascript
// jest.integration.config.js
const config = {
  testEnvironment: 'node',
  setupFilesAfterEnv: ['<rootDir>/jest.integration.setup.js'],
  testMatch: ['<rootDir>/tests/integration/**/*.test.{js,ts}'],
}

// .env.test
NEXT_PUBLIC_SUPABASE_URL=https://test.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=test-key
```

### RÃ©sultats Tests Actuels

**Tests Login (6/6 passing) âœ…**
- Connexion user avec credentials valides
- Connexion admin avec redirection /admin
- Connexion dev avec redirection /dev
- Rejet email invalide
- Rejet password trop court
- Gestion erreur Supabase credentials

**Tests Register (5/5 passing) âœ…**
- CrÃ©ation compte user avec donnÃ©es valides
- CrÃ©ation compte avec confirmation email
- Rejet email invalide
- Rejet password trop court
- Rejet passwords non identiques

### Exemples de Tests

```typescript
// tests/integration/auth/login-flow.test.ts
describe('Login Flow TDD', () => {
  it('devrait connecter dev avec redirection vers /dev', async () => {
    const result = await loginUser({
      email: 'dev@herbisveritas.fr',
      password: 'DevPassword123!'
    })
    
    expect(result.success).toBe(true)
    expect(result.user?.role).toBe('dev')
    expect(result.redirectTo).toBe('/dev')
  })
})
```

---

## Traduction d'Erreurs

### Messages Supabase â†’ FranÃ§ais

```typescript
// src/lib/auth/actions.ts
if (error) {
  let errorMessage = error.message
  
  // Traduction des erreurs courantes
  if (errorMessage.includes('User already registered')) {
    errorMessage = 'Un compte existe dÃ©jÃ  avec cet email'
  } else if (errorMessage.includes('Password should be at least')) {
    errorMessage = 'Le mot de passe doit respecter les critÃ¨res de sÃ©curitÃ©'
  }
  
  return { success: false, error: errorMessage }
}
```

---

## Configuration & DÃ©ploiement

### Variables d'Environnement

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# App Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

### Scripts de Test

```json
{
  "scripts": {
    "test:unit": "jest --config jest.config.js",
    "test:integration": "jest --config jest.integration.config.js",
    "test:auth": "npm run test:integration -- --testPathPatterns=auth",
    "build": "next build && npm run typecheck"
  }
}
```

---

## SÃ©curitÃ©

### Bonnes Pratiques ImplÃ©mentÃ©es

âœ… **Validation cÃ´tÃ© client et serveur** (Zod)  
âœ… **Protection CSRF** automatique (Supabase)  
âœ… **Cookies sÃ©curisÃ©s** (httpOnly, secure, sameSite)  
âœ… **Headers sÃ©curitÃ©** (middleware)  
âœ… **Row Level Security** (RLS Supabase)  
âœ… **Logs tentatives non autorisÃ©es**  

### Recommandations Production

ðŸ”„ **Ã€ implÃ©menter :**
- Rate limiting distribuÃ© (Redis)
- 2FA pour comptes admin
- Rotation refresh tokens
- Audit logs complets
- Monitoring sÃ©curitÃ©

---

## Ã‰volutions Futures

### Phase V2.1 (Post-MVP)
- [ ] 2FA avec TOTP
- [ ] Connexion sociale (Google, GitHub)
- [ ] Magic links email
- [ ] PWA offline auth

### Phase V2.2 (Enterprise)
- [ ] SSO entreprise
- [ ] Permissions granulaires
- [ ] Audit trail complet
- [ ] Multi-tenant auth

---

## Troubleshooting

### Erreurs Communes

**"Unauthorized access" en production :**
```typescript
// VÃ©rifier middleware matcher
export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}
```

**Tests Ã©chouent localement :**
```bash
# VÃ©rifier variables .env.test
cp .env.local .env.test
npm run test:integration
```

**Redirection infinie :**
```typescript
// VÃ©rifier routes publiques dans middleware
const isPublicRoute = PUBLIC_ROUTES.includes(pathname)
```

---

**Version :** 2.0.0  
**Date :** 2025-01-28  
**Statut :** âœ… Production Ready (Supabase Auth Migration Complete)  
**Tests :** 11/11 critiques passants  
**Next :** Semaine 3 MVP - Products & UI Components

Cette documentation reflÃ¨te l'implÃ©mentation complÃ¨te du systÃ¨me d'authentification Supabase avec tests TDD validÃ©s selon les standards CLAUDE.md.